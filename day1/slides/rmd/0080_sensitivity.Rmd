
```{r, include = FALSE}
source(here::here("day1/src/global.R"))
library(mrgsolve)
library(dplyr)
library(knitr)
library(lattice)
library(tidyverse)
library(patchwork)
select <- dplyr::select
```

# Sensitivity analysis

- Ad-hoc
  - Sequential: systematically vary the parameter value
  - Random: sample from a parametric or non-parametric distribution
- Local
    - small changes around a nominal value; one at a time
- Global
    - explore the whole parameter space; includes interactions


# Local sensitivity analysis 

We use the `lsa()` function from the mrgsim.sa package

```{r}
library(mrgsim.sa)
```


```{r, eval = FALSE}
?lsa
```

```{r, eval=FALSE}
sens <- lsa(model_object, parameter_names, output_variables)
```

# First, look at the result


```{r, echo = FALSE,fig.align="center", fig.height = 8, fig.width = 12}

mod <- modlib("irm1", end = 72, delta = 0.1)

sims <- mrgsim(mod, ev(amt = 100)) %>% as_tibble()
sens <- lsa(mod %>% ev(amt = 100), par = "CL,V2,Q,V3,KA", var = "CP", 
            eps = 1e-4)

p1 <- ggplot(sims, aes(time, CP)) + geom_line()
p2 <- lsa_plot(sens)
p1+p2
```


# A simulation scenario of interest

```{r}
mod <- modlib("irm1", end = 72, delta = 0.1)

mod %>%
  ev(amt = 100) %>% 
  mrgsim(end = 72, delta = 0.1) %>% 
  plot()
```


# lsa
```{r}
sens <- lsa(
  mod = ev(mod, amt = 100),
  par = "CL,V2,Q,KA", 
  var = "CP"
)

head(sens, n=3)
```

# The default plot method
```{r}
plot(sens)
```


# Global senstivity analysis

- All the parameters vary at once
- Investigate the whole parameter space
    - Or reasonable parameter space
- Evaluate both individual parameters as well as interactions between parameters
- Much greater computational burden


__We'll look at Sobol's method__


# Global senstivity analysis


- __Sobol Sensitivity Analysis: A Tool to Guide the Development and Evaluation of 
Systems Pharmacology Models.__
    - Zhang XY, Trame MN, Lesko LJ, Schmidt S.
    - CPT Pharmacometrics Syst Pharmacol. 2015 Feb;4(2):69-79. doi: 10.1002/psp4.6.
    - PMID: 27548289 
    - https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5006244/

# Global senstivity analysis


- __Sobol Sensitivity Analysis: A Tool to Guide the Development and Evaluation of 
~~Systems Pharmacology~~ PBPK Models.__
    - Zhang XY, Trame MN, Lesko LJ, Schmidt S.
    - CPT Pharmacometrics Syst Pharmacol. 2015 Feb;4(2):69-79. doi: 10.1002/psp4.6.
    - PMID: 27548289 
    - https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5006244/

# Sobol

- Variabillity in the output is decomposed, relating to variability in 
  different inputs or combinations of inputs
- We'll generate random samples of model parameters of interest and
  pass them off to `sensitivity::sobol2007`
- From our experience, put some reaonable limit parameter space
- Also, create a function that accepts a set of parameters and returns
  a simulated statistic of interest (like AUC)

